<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Smart Coach</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --bg1:#0f2027;
  --bg2:#203a43;
  --bg3:#2c5364;
  --accent:#22c55e;
  --glass:rgba(255,255,255,0.08);
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:Inter, Arial, sans-serif;
  background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));
  color:#fff;
}

.container{
  max-width:780px;
  margin:auto;
  padding:16px;
}

.header{
  text-align:center;
  font-size:22px;
  font-weight:700;
  margin-bottom:12px;
}

.modes{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  justify-content:center;
  margin-bottom:12px;
}

.modes button{
  padding:10px 16px;
  border-radius:999px;
  border:none;
  background:var(--accent);
  color:#052e16;
  font-weight:700;
  cursor:pointer;
}

.links{
  text-align:center;
  margin-bottom:10px;
}

.links a{
  color:var(--accent);
  text-decoration:none;
  font-weight:600;
  margin:0 8px;
}

.chat{
  background:var(--glass);
  border-radius:16px;
  padding:12px;
  min-height:380px;
  max-height:55vh;
  overflow-y:auto;
  backdrop-filter:blur(12px);
}

.msg{
  max-width:80%;
  padding:12px 14px;
  border-radius:14px;
  margin-bottom:10px;
  line-height:1.4;
}

.user{
  background:#1f2937;
  margin-left:auto;
}

.coach{
  background:#0f172a;
}

.info{
  max-width:100%;
  text-align:center;
  opacity:.8;
  font-size:14px;
}

.modeTag{
  font-size:11px;
  opacity:.6;
  margin-bottom:4px;
}

.inputBox{
  display:flex;
  gap:10px;
  margin-top:12px;
}

.inputBox input{
  flex:1;
  padding:14px;
  border-radius:999px;
  border:none;
  font-size:15px;
}

.inputBox button{
  padding:14px 20px;
  border-radius:999px;
  border:none;
  background:var(--accent);
  font-weight:700;
  cursor:pointer;
}

.status{
  text-align:center;
  font-size:14px;
  margin-top:8px;
  opacity:.85;
}

.actions{
  text-align:center;
  margin-top:8px;
}

.actions button{
  background:transparent;
  border:1px solid rgba(255,255,255,0.25);
  color:#fff;
  padding:6px 12px;
  border-radius:999px;
  cursor:pointer;
  font-size:13px;
}

.logout{
  text-align:center;
  margin-top:14px;
}

.logout a{
  color:#9ca3af;
  text-decoration:none;
}

/* METRICS STYLES */
.metrics{ display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:12px; margin-bottom:16px; }
.metric-card{ background:var(--glass); border-radius:16px; padding:12px; backdrop-filter:blur(12px); }
.metric-title{ font-size:13px; opacity:.7; margin-bottom:4px; }
.metric-value{ font-size:20px; font-weight:700; margin-bottom:6px; }
.bar{ height:6px; background:rgba(255,255,255,0.15); border-radius:999px; overflow:hidden; }
.fill{ height:100%; background:var(--accent); transition:width .6s ease; }
.bar.risk .fill{ background:#ef4444; }
.metric-badge{ padding:6px 12px; border-radius:999px; font-weight:600; display:inline-block; }
.metric-badge.low{ background:#16a34a; } .metric-badge.medium{ background:#f59e0b; } .metric-badge.high{ background:#ef4444; }

/* BURNOUT ALERT STYLES */
.burnout-alert{ background:linear-gradient(135deg,#ef4444,#b91c1c); padding:14px; border-radius:16px; margin-bottom:16px; font-weight:600; box-shadow:0 10px 25px rgba(239,68,68,0.25); animation:fadeIn .5s ease; }
.burnout-sub{ font-weight:400; font-size:13px; opacity:.9; margin-top:4px; }
@keyframes fadeIn{ from{opacity:0;transform:translateY(-5px);} to{opacity:1;transform:translateY(0);} }

/* CONFIDENCE CIRCULAR GAUGE STYLES */
.confidence-card{ display:flex; flex-direction:column; align-items:center; justify-content:center; }
.circle-wrapper{ width:90px; height:90px; margin-top:6px; }
.circle-chart{ width:100%; height:100%; transform:rotate(-90deg); }
.circle-bg{ fill:none; stroke:rgba(255,255,255,0.15); stroke-width:3.8; }
.circle-fill{ fill:none; stroke-width:3.8; stroke-linecap:round; transition:stroke-dasharray .6s ease; }
.circle-text{ fill:#fff; font-size:6px; text-anchor:middle; transform:rotate(90deg); }

/* TREND ARROW STYLES */
.trend{ font-size:14px; margin-left:6px; font-weight:700; }
.trend.up{ color:#22c55e; } .trend.down{ color:#ef4444; } .trend.stable{ color:#9ca3af; }

/* INJURY ALERT STYLES */
.injury-alert{ padding:14px; border-radius:16px; margin-bottom:16px; font-weight:600; animation:fadeIn .5s ease; }
.injury-alert.warning{ background:linear-gradient(135deg,#f59e0b,#b45309); }
.injury-alert.critical{ background:linear-gradient(135deg,#ef4444,#7f1d1d); }
.injury-sub{ font-weight:400; font-size:13px; opacity:.9; margin-top:4px; }

/* TRUST CARD STYLES */
.trust-card{ background:var(--glass); padding:14px; border-radius:16px; margin-bottom:16px; backdrop-filter:blur(12px); font-weight:600; }
.trust-sub{ font-weight:400; font-size:13px; opacity:.85; margin-top:4px; }

/* PERFORMANCE GRAPH STYLES */
.performance-graph{ margin-top:10px; height:40px; }
.graph-svg{ width:100%; height:100%; }
.graph-line{ stroke-dasharray:200; stroke-dashoffset:200; animation:drawLine 1s ease forwards; filter:drop-shadow(0 0 6px rgba(34,211,238,0.6)); }
@keyframes drawLine{ to{ stroke-dashoffset:0; } }

/* MOMENT REPLAY CARD STYLES */
.replay-card{ background:linear-gradient(135deg,#0ea5e9,#6366f1); padding:14px; border-radius:16px; margin-bottom:16px; font-weight:600; animation:fadeIn .5s ease; }

/* TOURNAMENT PROJECTION CARD STYLES */
.projection-card{ background:var(--glass); padding:14px; border-radius:16px; margin-bottom:16px; backdrop-filter:blur(12px); font-weight:500; }
</style>
</head>

<body>
<div class="container">

  <div class="header">üè∏ Smart Coach</div>

  <!-- BURNOUT ALERT BANNER -->
  {% if metrics.burnout_risk == "high" %}
  <div class="burnout-alert">
    ‚ö†Ô∏è High Burnout Risk Detected
    <div class="burnout-sub">Your recovery and confidence levels are low. Training intensity has been automatically adjusted.</div>
  </div>
  {% endif %}

  <!-- INJURY ADAPTIVE WARNING BANNER -->
  {% if metrics.injury_risk >= 85 %}
  <div class="injury-alert critical">
    üö® Critical Injury Risk Detected
    <div class="injury-sub">Training intensity has been reduced immediately to prevent injury.</div>
  </div>
  {% elif metrics.injury_risk >= 70 %}
  <div class="injury-alert warning">
    ‚ö†Ô∏è Elevated Injury Risk
    <div class="injury-sub">Load has been adjusted to protect recovery.</div>
  </div>
  {% endif %}

  <!-- METRICS SECTION -->
  <div class="metrics">
    <div class="metric-card">
      <div class="metric-title">üíö Recovery</div>
      <div class="metric-value">{{ metrics.recovery_score }}%</div>
      <div class="bar"><div class="fill" style="width:{{ metrics.recovery_score }}%"></div></div>
    </div>
    <div class="metric-card confidence-card">
      <div class="metric-title">üß† Confidence</div>
      <div class="circle-wrapper">
        <svg class="circle-chart" viewBox="0 0 36 36">
          <circle class="circle-bg" cx="18" cy="18" r="15.9"></circle>
          <circle class="circle-fill" cx="18" cy="18" r="15.9" stroke-dasharray="{{ metrics.confidence_score }}, 100" stroke="{% if metrics.confidence_score >= 70 %}#22c55e{% elif metrics.confidence_score >= 40 %}#f59e0b{% else %}#ef4444{% endif %}"></circle>
          <text class="circle-text" x="18" y="20.5">{{ metrics.confidence_score }}%</text>
        </svg>
      </div>
    </div>
    <div class="metric-card">
      <div class="metric-title">‚ö° Performance <span class="trend {% if trend_direction == 'up' %}up{% elif trend_direction == 'down' %}down{% else %}stable{% endif %}">{% if trend_direction == "up" %}‚Üë{% elif trend_direction == "down" %}‚Üì{% else %}‚Üí{% endif %}</span></div>
      <div class="metric-value">{{ metrics.performance_score }}%</div>
      <div class="bar"><div class="fill" style="width:{{ metrics.performance_score }}%"></div></div>
      <div class="performance-graph">
        <svg class="graph-svg" viewBox="0 0 100 40" preserveAspectRatio="none">
          <polyline class="graph-line" fill="none" stroke="#22d3ee" stroke-width="2" points="0,{{ 40 - (performance_history[0] * 0.4) }} 33,{{ 40 - (performance_history[1] * 0.4) }} 66,{{ 40 - (performance_history[2] * 0.4) }} 100,{{ 40 - (performance_history[3] * 0.4) }}"/>
        </svg>
      </div>
    </div>
    <div class="metric-card">
      <div class="metric-title">ü©π Injury Risk</div>
      <div class="metric-value">{{ metrics.injury_risk }}%</div>
      <div class="bar risk"><div class="fill" style="width:{{ metrics.injury_risk }}%"></div></div>
    </div>
    <div class="metric-card">
      <div class="metric-title">üî• Burnout</div>
      <span class="metric-badge {{ metrics.burnout_risk }}">{{ metrics.burnout_risk|capitalize }}</span>
    </div>
    <div class="metric-card">
      <div class="metric-title">üèÜ Tournament Ready</div>
      <div class="metric-value">{{ metrics.tournament_readiness }}%</div>
      <div class="bar"><div class="fill" style="width:{{ metrics.tournament_readiness }}%"></div></div>
    </div>
  </div>

  <!-- TRUST EXPLANATION CARD -->
  {% if metrics.burnout_risk == "high" or metrics.injury_risk >= 70 or metrics.recovery_score < 50 %}
  <div class="trust-card">
    üß† AI Adjustment Notice
    <div class="trust-sub">Your training plan was adapted based on recovery, confidence, and injury risk data.</div>
  </div>
  {% endif %}

  <!-- MOMENT REPLAY CARD -->
  {% if moment_replay is not none %}
  <div class="replay-card">
    üöÄ You improved {{ moment_replay }}% this month.
  </div>
  {% endif %}

  <!-- TOURNAMENT PROJECTION CARD -->
  <div class="projection-card">
    üìà At current trajectory, readiness may reach {{ projection }}% in 7 days.
  </div>

  <div class="modes">
    <button onclick="setMode('Training')">üèãÔ∏è Training</button>
    <button onclick="setMode('Diet')">ü•ó Diet</button>
    <button onclick="setMode('Injury')">ü©∫ Injury</button>
    <button onclick="setMode('Tournament')">üèÜ Tournament</button>
    <button onclick="setMode('Ask')">üí¨ Ask</button>
    {% if video_analysis_unlocked %}
<button onclick="location.href='/video-analysis'">
    üé• Video Analysis
</button>
{% else %}
<button disabled title="Complete your profile to unlock">
    üîí Video Analysis
</button>
{% endif %}
  </div>

  <div class="links">
    <a href="/coach-settings">‚öôÔ∏è Coach Settings</a> |
    <a href="/history">üìú History</a>
  </div>

  <div class="chat" id="chat"></div>

  <div class="actions">
    <button onclick="clearChat()">üßπ Clear chat</button>
  </div>

  <div class="inputBox">
    <input id="text" placeholder="Enable AI from Coach Settings" disabled>
    <button id="sendBtn" disabled onclick="send()">Send</button>
  </div>

  <div class="status" id="status">üîí Coach locked</div>

  <div class="logout">
    <a href="/logout">üö™ Logout</a>
  </div>

</div>

<script>
let mode = "Ask";
let aiEnabled = false;
let chatCache = null;
let isLoadingChat = false;
let chatRendered = false;  // üîê Track if chat has been rendered
const chat = document.getElementById("chat");

function escapeHTML(str){
  return str.replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  })[m]);
}

function addMsg(text, role, m){
  const d = document.createElement("div");
  d.className = role === "info" ? "info msg" : "msg " + role;
  d.innerHTML = m
    ? `<div class="modeTag">${m}</div>${escapeHTML(text)}`
    : escapeHTML(text);
  chat.appendChild(d);
  chat.scrollTop = chat.scrollHeight;
}

function renderChat(rows){
  // üîê TRUE WHATSAPP PERSISTENCE
  // If rows is empty/null AND chat is already rendered, DO NOT clear
  if((!rows || rows.length === 0) && chatRendered && chat.children.length > 0){
    // Keep existing DOM - do not clear
    return;
  }
  
  // If rows is empty/null AND chatCache is null (first load with no data)
  if(!rows || rows.length === 0){
    // Only show empty message if this is truly empty (no cache)
    if(chatCache === null || chatCache.length === 0){
      chat.innerHTML = "";
      addMsg("No previous messages yet. Ask your coach anything üëá", "info");
      chatRendered = true;
    }
    return;
  }
  
  // We have real data - render it
  chat.innerHTML = "";
  rows.forEach(r=>{
    addMsg(r.message, r.role === "user" ? "user" : "coach", r.mode);
  });
  chatRendered = true;
  
  // Always scroll to bottom after rendering
  chat.scrollTop = chat.scrollHeight;

// üîê TRUE WHATSAPP-LEVEL CHAT PERSISTENCE
function loadChat(force = false){
  // Prevent concurrent fetches
  if(isLoadingChat) return;
  
  isLoadingChat = true;
  
  // Always fetch from /api/chat-history
  fetch("/api/chat/history", { credentials:"same-origin" })
    .then(r => {
      if(!r.ok) throw new Error("Fetch failed");
      return r.json();
    })
    .then(data => {
    const rows = data.messages || data;   // <-- key fix
    chatCache = rows;
    renderChat(rows);
    isLoadingChat = false;
})
    .catch(err => {
      // On fetch fail, DO NOT clear chat - keep existing content
      console.warn("Chat fetch failed:", err);
      isLoadingChat = false;
      // If we have cached data and chat not rendered, render from cache
      if(chatCache !== null && !chatRendered){
        renderChat(chatCache);
      }
      // Otherwise keep existing DOM intact
    });
}

function setMode(m){
  mode = m;
  // Mode switch must NOT clear chat - just add info message
  addMsg(`Mode switched to ${m}`, "info");
  chat.scrollTop = chat.scrollHeight;
}

document.addEventListener("DOMContentLoaded", () => {
  // üîê Add 50ms delay before first fetch to avoid race condition
  setTimeout(() => loadChat(true), 50);

  fetch("/api/coach-settings",{ credentials:"same-origin" })
    .then(r=>r.json())
    .then(d=>{
      if(d.ai_enabled){
        aiEnabled = true;
        text.disabled = false;
        sendBtn.disabled = false;
        text.placeholder = "Ask your coach‚Ä¶";
        status.innerText = "üü¢ Coach active";
      }
    });
});

// üîê WhatsApp-level restore on pageshow (back/forward navigation)
window.addEventListener("pageshow", (event) => {
  // Force reload on back/forward to rehydrate from DB
  setTimeout(() => loadChat(true), 50);
});

// üîê Reload chat when tab becomes visible
document.addEventListener("visibilitychange", () => {
  if (!document.hidden) {
    setTimeout(() => loadChat(true), 50);
  }
});

function send(){
  const msg = text.value.trim();
  if(!msg || !aiEnabled) return;

  addMsg(msg, "user", mode);
  text.value = "";
  chat.scrollTop = chat.scrollHeight;

  fetch("/api/coach",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    credentials:"same-origin",
    body:JSON.stringify({ text:msg, mode })
  })
  .then(r=>r.json())
  .then(d=>{
    addMsg(d.reply, "coach", mode);
    // Invalidate cache so next load fetches fresh
    chatCache = null;
    chat.scrollTop = chat.scrollHeight;
  });
}

function clearChat(){
  if(!confirm("Clear all chat messages?")) return;

  fetch("/api/clear-chat",{
    method:"POST",
    credentials:"same-origin"
  }).then(()=>{
    chatCache = [];
    chatRendered = false;
    chat.innerHTML = "";
    addMsg("No previous messages yet. Ask your coach anything üëá", "info");
    chatRendered = true;
  });
}
</script>

</body>
</html>
